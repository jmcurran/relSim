#include <math.h>
#include <iostream>

extern "C" {
  int ix, iy, iz;

  unsigned long zunif(){
    ix = (171 * ix) % 30269;
    iy = (172 * iy) % 30307;
    iz = (170 * iz) % 30223;

    return ix + iy + iz;
  }

  double runif(){
    ix = (171 * ix) % 30269;
    iy = (172 * iy) % 30307;
    iz = (170 * iz) % 30223;

    double r = ix / 30269.0 + iy / 30307.0 + iz / 30323.0;
    return r - floor(r);
  }

  void breed(int *pnParents, int *ns, int *Ns, int *nLoci,
	     int *x, int *y, int *z){
    int s;
    int i1;//, i2;
    int i;
    int nNumAlleles = (*ns)*(*Ns)*2*(*nLoci);

    int *pnChildren = new int[nNumAlleles];

    ix = *x;
    iy = *y;
    iz = *z;

    for(s = 0; s < *ns; s++){
      i1 = s*(*Ns)*2*(*nLoci);

      //i2 = i1 + *Ns - 1;

      int p1;
      int p2;

      int ctr = 0;
      unsigned int g, u = zunif();
      int loc;

      for(i = 0; i < (*Ns); i++){
	p1 = i1 + 2*(*nLoci)*floor(*Ns*runif());
	p2 = i1 + 2*(*nLoci)*floor(*Ns*runif());

	std::cout << p1 << ',' << p2 << std::endl;

	for(loc = 0; loc < *nLoci; loc++){
	  g = u & 1; // this pops a bit off u
	  u >>= 1; // and this shifts to the right so the bit is removed

	  // g will be 0 or 1
	  pnChildren[i1 + i + 2*loc] = pnParents[p1 + 2*loc + g];

	  g = u & 1; // this pops a bit off u
	  u >>= 1; // and this shifts to the right so the bit is removed
	  ctr += 2;

	  pnChildren[i1 + i + 2*loc + 1] = pnParents[p2 + 2*loc + g];

	  if(pnChildren[i1 + i + 2*loc] > pnChildren[i1 + i + 2*loc + 1]){
	    int nSwap = pnChildren[i1 + i + 2*loc];

	    pnChildren[i1 + i + 2*loc] = pnChildren[i1 + i + 2*loc + 1];
	    pnChildren[i1 + i + 2*loc + 1] = nSwap;
	  }

	  if(ctr == 16){
	    u = zunif();
	    ctr = 0;
	  }
	}
      }
    }

    for(i = 0; i < nNumAlleles; i++){
      pnParents[i] = pnChildren[i];
    }

    // preserve the random number seeds

    *x = ix;
    *y = iy;
    *z = iz;

    delete [] pnChildren;
  }
}
